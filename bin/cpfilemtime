#!/usr/bin/env ruby
require 'dirwalk'
require 'win32_filetime'
W = Win32ft

def syntax
	p %{Syntax:  setft file_getMtime  set1 set2 ...}
	exit(0)
end

if ARGV.include?('-h') ||  ARGV.include?('--help')
	syntax
end
if ARGV.include?('-d')
	ARGV.delete('-d')
	$debug = true
end
if ARGV.size < 2
	syntax
end

fn=ARGV[0]
c,a,m=W.getfiletime(fn)

puts %{get file "#{fn}" mtime "#{W.ft2st(m)}"}


rrs = ARGV[1..-1]

def walkdir(fn1, m)
	p %{walk   #{fn1} }

	if File.file?(fn1)
		fn1 = fn1.gsub('/', "\\")
		res = W.setfiletime(fn1, m,m,m)
		p %{ setT   #{fn1}  #{res}} if $debug
	elsif File.directory?(fn1)
		Dir.walk(fn1) do |dirn, subdirns, fns|
			fns.each do |fn2|
				fn2 = File.join(dirn, fn2).gsub('/', "\\")
				res = W.setfiletime(fn2, m,m,m)
				p %{  setT2   #{fn2} #{res} } if $debug
			end
			subdirns.each do |subdirn|
				walkdir(File.join(dirn, subdirn), m)
			end
		end
	end
end

rrs.each do |rr|
	rr = rr.gsub("\\", '/')
	fs = Dir.glob rr
	fs.each do |fn|
		walkdir(fn, m)
	end
end
