#!/usr/bin/env ruby -w
# encoding: GBK

require 'openssl'
require 'win32_filetime'
W = Win32ft

trap "SIGINT" do
  STDERR.puts "\nexit on Ctrl-C."
  exit 1
end

def rolloldtime(d1, logf)
  logf = File.absolute_path(logf)
  c_ds = 0
  c_fs = 0
  Dir.chdir(d1) do
    File.foreach(logf) do |line|
      line.strip!
      next if line.empty?
      p1 = line.index(/ 0x\w+ 0x\w+ 0x\w+ \d+$/)
      next if !p1

      fn = line[0...p1]
      next if $just_dir && !File.directory?(fn)
      if File.file?(fn)
        c_fs += 1
      elsif File.directory?(fn)
        c_ds += 1
      else
        next
      end

      tc1,ta1,tm1,_sz1 = line[p1..-1].split
      W.setfiletime(fn, tc1, ta1, tm1) rescue STDERR.puts "\n Error! #{fn}"
    end
  end
  STDERR.puts " Restoreoldtimes \"#{d1}\"   dirs: #{c_ds}  files: #{c_fs}"
  c_fs
end

def main
  $just_dir = ARGV.delete('-o') ? true : false
  if ARGV.size != 2
    STDERR.puts "Syntax: restoreoldtimes.rb  Dir1 file.log  [ -o ] # -o just_dir "
    exit 1
  end
  if !File.directory?(ARGV[0]) || !File.file?(ARGV[1])
    STDERR.puts "Syntax:  Dir1  file.log.\n   using file.log restore directory files times"
  end
  rolloldtime(ARGV[0], ARGV[1])
end

main
